<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>塔罗牌解读</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="reading.css">
</head>
<body>
    <button class="back-button" onclick="window.location.href='draw.html'">
        <i class="fas fa-arrow-left"></i>
    </button>
    <div class="container">
        <h1>✨ 塔罗牌解读 ✨</h1>
        <p class="question" id="userQuestion"></p>
        <div class="cards-show" id="cardsShow"></div>
        <div class="reading reading-magic" id="reading">
            <div class="loading">正在解读命运... 🔮</div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            const userQuestion = localStorage.getItem('userQuestion') || '（未填写）';
            const drawnCards = JSON.parse(localStorage.getItem('drawnCards') || '[]');
            document.getElementById('userQuestion').textContent = `「${userQuestion}」`;

            // 展示三张牌
            const cardsShow = document.getElementById('cardsShow');
            cardsShow.innerHTML = drawnCards.map((card, idx) => `
                <div class="card-magic">
                    <img src="${card.image}" alt="${card.name}">
                    <div class="card-name">${card.name}</div>
                    <div class="card-position">${['过去','现在','未来'][idx]}</div>
                    <div class="card-status">${card.reversed ? '逆位' : '正位'}</div>
                </div>
            `).join('');

            // 生成prompt
            const prompt = `你是一位具有同理心和现实判断力的塔罗牌解读者。\n\n用户给出了一个具体的问题，并抽取了三张塔罗牌（包含正位或逆位）。请你根据这些信息：\n\n1. 准确分析用户的问题在现实中可能涉及的心理、行为或环境因素。\n2. 根据每张牌的含义，指出用户当前处境中值得注意的关键点。\n3. 综合三张牌，给出有针对性、具有实际行动性的建议，帮助用户做出决策或获得支持。\n\n请使用以下结构输出：\n\n🔮【命运指引】：用2句话给出对当前问题的总体判断和趋势  \n🃏【牌面解析】：  \n- 过去：[${drawnCards[0]?.name || ''}]（${drawnCards[0]?.reversed ? '逆位' : '正位'}）→  \n- 现在：[${drawnCards[1]?.name || ''}]（${drawnCards[1]?.reversed ? '逆位' : '正位'}）→  \n- 未来：[${drawnCards[2]?.name || ''}]（${drawnCards[2]?.reversed ? '逆位' : '正位'}）→  \n💡【实用建议】：请提出 3 条有现实参考价值的建议，语言温和、具体，不要空洞套话。\n\n用户问题：「${userQuestion}」`;

            try {
                const response = await fetch('https://oai.nowchat.icu/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer sk-BLu3Hj8zD2spXXUYaEIr4o2NEv4b4AjVZeZPs1WKjgaK9Yqe'
                    },
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo',
                        temperature: 0.8,
                        messages: [
                            { role: 'system', content: '你是一位具有同理心和现实判断力的塔罗牌解读者。' },
                            { role: 'user', content: prompt }
                        ]
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('API Error:', errorData);
                    document.getElementById('reading').innerHTML = '命运解读失败，请稍后重试。错误信息：' + (errorData.error?.message || '未知错误');
                    return;
                }

                const data = await response.json();
                const result = data.choices?.[0]?.message?.content?.trim();
                if (!result) {
                    throw new Error('No response content');
                }
                document.getElementById('reading').innerHTML = result;
            } catch (e) {
                console.error('Error:', e);
                document.getElementById('reading').innerHTML = '命运解读失败，请检查网络或稍后重试。错误信息：' + e.message;
            }
        });
    </script>
    <script src="script.js"></script>
    <script src="bgm.js"></script>
</body>
</html> 